<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniWay - Mapa Interactivo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        let map, markerOri, markerDest;
        let seleccionando = null; // Guarda quÃ© input estamos rellenando
        let gruposContador = { ida: 0, vuelta: 0 };

        // Inicializar Mapa
        function initMap() {
            map = L.map('map-container').setView([40.4167, -3.7037], 6); // Centrado en EspaÃ±a
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            map.on('click', async function(e) {
                if (!seleccionando) {
                    alert("Primero selecciona el campo Origen o Destino que quieres marcar.");
                    return;
                }
                const { lat, lng } = e.latlng;
                actualizarPunto(lat, lng);
            });
        }

        function setSeleccion(tipo, n, campo) {
            seleccionando = { tipo, n, campo };
            // Resaltar visualmente el input activo
            document.querySelectorAll('.geo-input').forEach(i => i.style.borderColor = '#e2e8f0');
            document.getElementById(`${tipo}_${campo}_${n}`).style.borderColor = 'var(--primary)';
        }

        async function actualizarPunto(lat, lng) {
            const { tipo, n, campo } = seleccionando;
            const input = document.getElementById(`${tipo}_${campo}_${n}`);
            
            // Reverse Geocoding: De coordenadas a nombre de ciudad
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const data = await res.json();
            input.value = data.display_name.split(',')[0] + (data.address.city ? ", " + data.address.city : "");
            
            // Guardar coordenadas ocultas en el input para el cÃ¡lculo
            input.dataset.lat = lat;
            input.dataset.lng = lng;

            // Dibujar marcadores
            if (campo === 'ori') {
                if (markerOri) markerOri.setLatLng([lat, lng]);
                else markerOri = L.marker([lat, lng], {icon: L.divIcon({className: 'marker-ori'})}).addTo(map);
            } else {
                if (markerDest) markerDest.setLatLng([lat, lng]);
                else markerDest = L.marker([lat, lng], {icon: L.divIcon({className: 'marker-dest'})}).addTo(map);
            }

            calcularRutaOSRM(tipo, n);
        }

        async function calcularRutaOSRM(tipo, n) {
            const ori = document.getElementById(`${tipo}_ori_${n}`);
            const dest = document.getElementById(`${tipo}_dest_${n}`);
            
            if (ori.dataset.lat && dest.dataset.lat) {
                const url = `https://router.project-osrm.org/route/v1/driving/${ori.dataset.lng},${ori.dataset.lat};${dest.dataset.lng},${dest.dataset.lat}?overview=full&geometries=geojson`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.routes && data.routes.length > 0) {
                    const km = (data.routes[0].distance / 1000).toFixed(1);
                    document.getElementById(`${tipo}_km_${n}`).value = km;
                    document.getElementById(`${tipo}_status_${n}`).innerText = `âœ… ${km} km por carretera`;
                }
            }
        }

        function agregarGrupo(tipo) {
            gruposContador[tipo]++;
            const n = gruposContador[tipo];
            const container = document.getElementById(`listaGrupos${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            const div = document.createElement('div');
            div.className = 'grupo';
            div.innerHTML = `
                <h4>Grupo ${tipo} ${n}</h4>
                <input type="text" name="${tipo}_amigos_${n}" placeholder="Amigos: Ana, Pepe..." required>
                <div class="route-inputs">
                    <input type="text" id="${tipo}_ori_${n}" class="geo-input" placeholder="ðŸ“ Origen" onfocus="setSeleccion('${tipo}', ${n}, 'ori')" readonly>
                    <input type="text" id="${tipo}_dest_${n}" class="geo-input" placeholder="ðŸ Destino" onfocus="setSeleccion('${tipo}', ${n}, 'dest')" readonly>
                </div>
                <input type="number" step="0.1" name="${tipo}_dist_${n}" id="${tipo}_km_${n}" readonly class="km-readonly" placeholder="KM">
                <p id="${tipo}_status_${n}" class="status-text"></p>
            `;
            container.appendChild(div);
            document.getElementById(`total_grupos_${tipo}`).value = n;
        }

        window.onload = initMap;
    </script>
</head>
<body>
    <div id="layout">
        <div id="sidebar">
            <h1>AniWay</h1>
            <form method="POST">
                <label>Coste Total (â‚¬)</label>
                <input type="number" step="0.01" name="coste_total" required>
                
                <div id="listaGruposIda"></div>
                <button type="button" onclick="agregarGrupo('ida')">+ Grupo Ida</button>
                <input type="hidden" id="total_grupos_ida" name="total_grupos_ida" value="0">

                <div id="listaGruposVuelta"></div>
                <button type="button" onclick="agregarGrupo('vuelta')">+ Grupo Vuelta</button>
                <input type="hidden" id="total_grupos_vuelta" name="total_grupos_vuelta" value="0">

                <button type="submit" class="btn-main">Calcular Reparto</button>
            </form>

            {% if resultados %}
            <div class="resultados-card">
                {% for r in resultados %}
                <div class="resultado-item">
                    <span>{{ r.nombre }}</span>
                    <strong>{{ r.coste }} â‚¬</strong>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <div id="map-container"></div>
    </div>
</body>
</html>
