<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniWay - Autocompletado Total</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://unpkg.com/leaflet-geosearch@3.8.0/dist/bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.8.0/dist/geosearch.css" />

    <style>
        :root { --primary: #6366f1; --border: #e2e8f0; --text: #1e293b; }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; height: 100vh; font-family: sans-serif; overflow: hidden; }
        
        #layout { display: flex; height: 100vh; }
        
        #sidebar { 
            width: 400px; min-width: 400px; padding: 25px; 
            background: white; border-right: 1px solid var(--border);
            overflow-y: auto; z-index: 100;
        }

        #map-container { flex-grow: 1; height: 100%; background: #ddd; }

        .grupo { background: #f8fafc; border: 1px solid var(--border); padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        
        .search-box { position: relative; margin-bottom: 10px; }
        input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
        input.active { border: 2px solid var(--primary); background: #f5f7ff; }

        /* Sugerencias desplegables */
        .autocomplete-results {
            position: absolute; top: 42px; left: 0; right: 0;
            background: white; border: 1px solid var(--border);
            border-radius: 8px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-height: 200px; overflow-y: auto;
        }
        .result-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 13px; }
        .result-item:hover { background: #f1f5f9; color: var(--primary); }

        .km-readonly { background: #f1f5f9; font-weight: bold; text-align: center; color: var(--primary); }
        .btn-main { background: var(--primary); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-add { background: #eef2ff; color: var(--primary); border: none; padding: 10px; width: 100%; border-radius: 8px; cursor: pointer; margin-bottom: 10px; }
        
        @media (max-width: 768px) { #layout { flex-direction: column-reverse; } #sidebar { width: 100%; height: 50%; } #map-container { height: 50%; } }
    </style>
</head>
<body>

<div id="layout">
    <div id="sidebar">
        <h1>AniWay</h1>
        <form method="POST">
            <label>Coste Total (â‚¬)</label>
            <input type="number" step="0.01" name="coste_total" placeholder="0.00" required>
            
            <h3>Ida</h3>
            <div id="listaGruposIda"></div>
            <button type="button" class="btn-add" onclick="agregarGrupo('ida')">+ Grupo Ida</button>
            <input type="hidden" id="total_grupos_ida" name="total_grupos_ida" value="0">

            <h3>Vuelta</h3>
            <div id="listaGruposVuelta"></div>
            <button type="button" class="btn-add" onclick="agregarGrupo('vuelta')">+ Grupo Vuelta</button>
            <input type="hidden" id="total_grupos_vuelta" name="total_grupos_vuelta" value="0">

            <button type="submit" class="btn-main">CALCULAR</button>
        </form>

        {% if resultados %}
        <div style="margin-top:20px; border-top: 2px solid var(--primary); padding-top:10px;">
            <h4>Resumen</h4>
            {% for r in resultados %}
            <div style="display:flex; justify-content: space-between; padding: 5px 0;">
                <span>{{ r.nombre }}</span>
                <strong>{{ r.coste }} â‚¬</strong>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    <div id="map-container"></div>
</div>

<script>
    let map, markerOri, markerDest, seleccionando = null;
    let gruposContador = { ida: 0, vuelta: 0 };
    const provider = new window.GeoSearch.OpenStreetMapProvider();

    function initMap() {
        map = L.map('map-container').setView([40.41, -3.70], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        map.on('click', function(e) {
            if (!seleccionando) return alert("Selecciona primero un campo de Origen o Destino.");
            actualizarPunto(e.latlng.lat, e.latlng.lng);
        });
    }

    function setSeleccion(tipo, n, campo) {
        seleccionando = { tipo, n, campo };
        document.querySelectorAll('input').forEach(i => i.classList.remove('active'));
        document.getElementById(`${tipo}_${campo}_${n}`).classList.add('active');
    }

    async function actualizarPunto(lat, lng, nombre = null) {
        const { tipo, n, campo } = seleccionando;
        const input = document.getElementById(`${tipo}_${campo}_${n}`);
        
        if (!nombre) {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const data = await res.json();
            input.value = data.display_name.split(',')[0];
        } else {
            input.value = nombre;
        }
        
        input.dataset.lat = lat;
        input.dataset.lng = lng;

        if (campo === 'ori') {
            if (markerOri) markerOri.setLatLng([lat, lng]);
            else markerOri = L.marker([lat, lng]).addTo(map);
        } else {
            if (markerDest) markerDest.setLatLng([lat, lng]);
            else markerDest = L.marker([lat, lng]).addTo(map);
        }
        
        map.panTo([lat, lng]);
        calcularRuta(tipo, n);
    }

    async function calcularRuta(tipo, n) {
        const o = document.getElementById(`${tipo}_ori_${n}`);
        const d = document.getElementById(`${tipo}_dest_${n}`);
        if (o.dataset.lat && d.dataset.lat) {
            const url = `https://router.project-osrm.org/route/v1/driving/${o.dataset.lng},${o.dataset.lat};${d.dataset.lng},${d.dataset.lat}?overview=false`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.routes && data.routes.length > 0) {
                const km = (data.routes[0].distance / 1000).toFixed(1);
                document.getElementById(`${tipo}_km_${n}`).value = km;
                document.getElementById(`${tipo}_status_${n}`).innerText = "âœ… " + km + " km";
            }
        }
    }

    function agregarGrupo(tipo) {
        gruposContador[tipo]++;
        const n = gruposContador[tipo];
        const div = document.createElement('div');
        div.className = 'grupo';
        div.innerHTML = `
            <h4>Tramo ${n}</h4>
            <input type="text" name="${tipo}_amigos_${n}" placeholder="Amigos (Ana, Pepe...)">
            <div class="search-box">
                <input type="text" id="${tipo}_ori_${n}" placeholder="ðŸ“ Origen" onfocus="setSeleccion('${tipo}',${n},'ori')" autocomplete="off">
                <div id="res_${tipo}_ori_${n}" class="autocomplete-results"></div>
            </div>
            <div class="search-box">
                <input type="text" id="${tipo}_dest_${n}" placeholder="ðŸ Destino" onfocus="setSeleccion('${tipo}',${n},'dest')" autocomplete="off">
                <div id="res_${tipo}_dest_${n}" class="autocomplete-results"></div>
            </div>
            <input type="number" name="${tipo}_dist_${n}" id="${tipo}_km_${n}" readonly class="km-readonly" placeholder="0.0 km">
            <p id="${tipo}_status_${n}" style="font-size:12px; color:green; margin:5px 0 0 0;"></p>
        `;
        document.getElementById(`listaGrupos${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).appendChild(div);
        document.getElementById(`total_grupos_${tipo}`).value = n;

        configurarAutocompletado(`${tipo}_ori_${n}`, `res_${tipo}_ori_${n}`);
        configurarAutocompletado(`${tipo}_dest_${n}`, `res_${tipo}_dest_${n}`);
    }

    function configurarAutocompletado(inputId, resId) {
        const input = document.getElementById(inputId);
        const resDiv = document.getElementById(resId);

        input.addEventListener('input', async (e) => {
            const query = e.target.value;
            if (query.length < 3) { resDiv.innerHTML = ''; return; }

            const results = await provider.search({ query });
            resDiv.innerHTML = '';
            results.slice(0, 5).forEach(r => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerText = r.label;
                item.onclick = () => {
                    resDiv.innerHTML = '';
                    actualizarPunto(r.y, r.x, r.label);
                };
                resDiv.appendChild(item);
            });
        });
    }

    window.onload = initMap;
</script>
</body>
</html>
