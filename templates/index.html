<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>AniWay - Calculadora Inteligente</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=places"></script>
  
  <script>
    let gruposContador = { ida: 0, vuelta: 0 };

    function agregarGrupo(tipo) {
        gruposContador[tipo]++;
        const n = gruposContador[tipo];
        const container = document.getElementById(`listaGrupos${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);

        const div = document.createElement('div');
        div.className = 'grupo';
        div.innerHTML = `
            <h4>Grupo ${tipo} ${n}</h4>
            <label>Amigos (separados por coma):</label>
            <input type="text" name="${tipo}_amigos_${n}" placeholder="Ej: Ana, Luis, Pedro" required>
            
            <div class="route-inputs">
                <div>
                    <label>Origen:</label>
                    <input type="text" id="${tipo}_ori_${n}" placeholder="Punto de inicio" class="geo-input">
                </div>
                <div>
                    <label>Destino:</label>
                    <input type="text" id="${tipo}_dest_${n}" placeholder="Punto de llegada" class="geo-input">
                </div>
            </div>

            <label>Distancia calculada (km):</label>
            <input type="number" step="0.1" name="${tipo}_dist_${n}" id="${tipo}_km_${n}" readonly class="km-readonly">
            <p id="${tipo}_status_${n}" class="status-text"></p>
        `;
        container.appendChild(div);

        // 1. Activar Autocomplete en los nuevos inputs
        initAutocomplete(`${tipo}_ori_${n}`, `${tipo}_dest_${n}`, `${tipo}_km_${n}`, `${tipo}_status_${n}`);
        
        // 2. Actualizar contadores ocultos para Flask
        document.getElementById(`total_grupos_${tipo}`).value = n;
    }

    function initAutocomplete(idOri, idDest, idKm, idStatus) {
        const oriInput = document.getElementById(idOri);
        const destInput = document.getElementById(idDest);
        
        const options = { types: ['geocode', 'establishment'] };
        const autoOri = new google.maps.places.Autocomplete(oriInput, options);
        const autoDest = new google.maps.places.Autocomplete(destInput, options);

        // Cuando cambie cualquiera de los dos, intentar calcular distancia
        [autoOri, autoDest].forEach(auto => {
            auto.addListener('place_changed', () => calcularDistanciaReal(oriInput.value, destInput.value, idKm, idStatus));
        });
    }

    function calcularDistanciaReal(origen, destino, idKm, idStatus) {
        if (!origen || !destino) return;

        const service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix({
            origins: [origen],
            destinations: [destino],
            travelMode: 'DRIVING',
            unitSystem: google.maps.UnitSystem.METRIC
        }, (response, status) => {
            if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                const distanciaMetros = response.rows[0].elements[0].distance.value;
                const km = (distanciaMetros / 1000).toFixed(1);
                document.getElementById(idKm).value = km;
                document.getElementById(idStatus).innerText = `üöó Ruta encontrada: ${km} km`;
            } else {
                document.getElementById(idStatus).innerText = "‚ùå No se pudo calcular la ruta por carretera.";
            }
        });
    }
  </script>
</head>
<body>
    </body>
</html>
