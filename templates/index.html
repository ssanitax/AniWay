<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniWay - Calculadora Inteligente</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        let gruposContador = { ida: 0, vuelta: 0 };

        function agregarGrupo(tipo) {
            gruposContador[tipo]++;
            const n = gruposContador[tipo];
            const container = document.getElementById(`listaGrupos${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);

            const div = document.createElement('div');
            div.className = 'grupo';
            div.innerHTML = `
                <h4>Grupo ${tipo} ${n}</h4>
                <label>Amigos (separados por coma):</label>
                <input type="text" name="${tipo}_amigos_${n}" placeholder="Ej: Ana, Luis" required>
                
                <div class="route-inputs">
                    <div>
                        <label>Origen:</label>
                        <input type="text" id="${tipo}_ori_${n}" placeholder="Ciudad de inicio" onchange="buscarRuta('${tipo}', ${n})">
                    </div>
                    <div>
                        <label>Destino:</label>
                        <input type="text" id="${tipo}_dest_${n}" placeholder="Ciudad de llegada" onchange="buscarRuta('${tipo}', ${n})">
                    </div>
                </div>

                <label>Distancia por carretera (km):</label>
                <input type="number" step="0.1" name="${tipo}_dist_${n}" id="${tipo}_km_${n}" readonly class="km-readonly" required>
                <p id="${tipo}_status_${n}" class="status-text"></p>
            `;
            container.appendChild(div);
            document.getElementById(`total_grupos_${tipo}`).value = n;
        }

        function obtenerCoordenadas(direccion) {
            return new Promise((resolve) => {
                const geocoder = L.Control.Geocoder.nominatim();
                geocoder.geocode(direccion, (results) => {
                    if (results && results.length > 0) {
                        resolve({
                            lat: results[0].center.lat,
                            lng: results[0].center.lng
                        });
                    } else {
                        resolve(null);
                    }
                });
            });
        }

        async function buscarRuta(tipo, n) {
            const oriVal = document.getElementById(`${tipo}_ori_${n}`).value;
            const destVal = document.getElementById(`${tipo}_dest_${n}`).value;
            const status = document.getElementById(`${tipo}_status_${n}`);
            const kmInput = document.getElementById(`${tipo}_km_${n}`);

            if (oriVal.length > 2 && destVal.length > 2) {
                status.innerText = "‚è≥ Buscando direcciones...";
                status.style.color = "#64748b";
                
                const coordOri = await obtenerCoordenadas(oriVal);
                const coordDest = await obtenerCoordenadas(destVal);

                if (coordOri && coordDest) {
                    status.innerText = "üöó Calculando ruta...";
                    
                    // URL de OSRM (Importante el orden lng,lat)
                    const url = `https://router.project-osrm.org/route/v1/driving/${coordOri.lng},${coordOri.lat};${coordDest.lng},${coordDest.lat}?overview=false`;
                    
                    try {
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        if (data.routes && data.routes.length > 0) {
                            const distanciaKm = (data.routes[0].distance / 1000).toFixed(1);
                            kmInput.value = distanciaKm;
                            status.innerText = `‚úÖ Ruta: ${distanciaKm} km`;
                            status.style.color = "#10b981";
                        } else {
                            status.innerText = "‚ùå No se encontr√≥ ruta terrestre.";
                            status.style.color = "#ef4444";
                        }
                    } catch (e) {
                        status.innerText = "‚ùå Error en el servidor de mapas.";
                    }
                } else {
                    status.innerText = "üîç Localidad no encontrada.";
                }
            }
        }
    </script>
</head>
<body>

    <h1>AniWay</h1>

    <form method="POST">
        <h2>Presupuesto</h2>
        <label>Coste total del viaje (‚Ç¨):</label>
        <input type="number" step="0.01" name="coste_total" placeholder="0.00" required>

        <h2>Trayectos de Ida</h2>
        <div id="listaGruposIda"></div>
        <input type="hidden" id="total_grupos_ida" name="total_grupos_ida" value="0">
        <button type="button" onclick="agregarGrupo('ida')">+ A√±adir tramo de ida</button>

        <h2>Trayectos de Vuelta</h2>
        <div id="listaGruposVuelta"></div>
        <input type="hidden" id="total_grupos_vuelta" name="total_grupos_vuelta" value="0">
        <button type="button" onclick="agregarGrupo('vuelta')">+ A√±adir tramo de vuelta</button>

        <button type="submit" style="margin-top: 30px; background: var(--primary); color: white; border: none;">
            Calcular Reparto de Gastos
        </button>
    </form>

    {% if resultados %}
    <div class="resultados-card">
        <h2>Resumen por persona</h2>
        <div class="resultados-list">
            {% for r in resultados %}
            <div class="resultado-item">
                <span class="res-nombre">{{ r.nombre }}</span>
                <div>
                    <span class="res-coste">{{ r.coste }} ‚Ç¨</span>
                    <small style="color: var(--text-muted); margin-left: 8px;">{{ r.km }} km</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</body>
</html>
